<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Metronome with Chords</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    #bpm {
      width: 200px;
    }
    #current-chord, #next-chord {
      font-size: 1.2em;
      margin: 10px;
    }
    #beat-tracker {
      display: flex;
      justify-content: center;
      margin: 20px;
      font-size: 1.2em;
    }
    .beat-marker {
      width: 30px;
      text-align: center;
      position: relative;
    }
    .beat-marker::after {
      content: "";
      display: block;
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      position: absolute;
      bottom: -15px;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
    }
    .beat-marker.active::after {
      opacity: 1;
    }
    .bpm-controls {
      margin: 10px;
    }
    .bpm-controls button {
      margin: 5px;
      padding: 5px 10px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <h1>Metronome with Chords</h1>
  <div class="bpm-controls">
    <button id="bpm-minus-5">-5</button>
    <button id="bpm-minus-1">-1</button>
    <span id="bpm-value">60</span>
    <button id="bpm-plus-1">+1</button>
    <button id="bpm-plus-5">+5</button>
  </div>
  <div>
    <label for="bpm">BPM: </label>
    <input type="range" id="bpm" min="40" max="200" value="60">
  </div>
  <div id="current-chord">Play: C Maj7 (root)</div>
  <div id="next-chord">Next: D-7 (1st)</div>
  <div id="beat-tracker">
    <div class="beat-marker">1</div>
    <div class="beat-marker">2</div>
    <div class="beat-marker">3</div>
    <div class="beat-marker">4</div>
    <div class="beat-marker">1</div>
    <div class="beat-marker">2</div>
    <div class="beat-marker">3</div>
    <div class="beat-marker">4</div>
  </div>
  <button id="start">Start</button>
  <button id="stop">Stop</button>

  <script>
    // Audio context and sound setup
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    let oscillator;
    let gainNode;

    // Metronome state
    let bpm = 60;
    let beat = 0; // Beat counter (0 to 7)
    let interval;
    let firstRound = true; // Flag to track the first round
    let isInitialized = false; // Flag to track initialization

    // Chord data
    const keys = ["C", "C#/D♭", "D", "D#/E♭", "E", "F", "F#/G♭", "G", "G#/A♭", "A", "A#/B♭", "B"];
    const chordTypes = ["Maj7", "-7", "7", "ø7"];
    const inversions = ["root", "1st", "2nd", "3rd"];

    // DOM elements
    const bpmSlider = document.getElementById('bpm');
    const bpmValue = document.getElementById('bpm-value');
    const currentChordDisplay = document.getElementById('current-chord');
    const nextChordDisplay = document.getElementById('next-chord');
    const beatMarkers = document.querySelectorAll('.beat-marker');
    const startButton = document.getElementById('start');
    const stopButton = document.getElementById('stop');
    const bpmMinus5Button = document.getElementById('bpm-minus-5');
    const bpmMinus1Button = document.getElementById('bpm-minus-1');
    const bpmPlus1Button = document.getElementById('bpm-plus-1');
    const bpmPlus5Button = document.getElementById('bpm-plus-5');

    // Function to generate a random chord
    function getRandomChord() {
      const key = keys[Math.floor(Math.random() * keys.length)];
      const chordType = chordTypes[Math.floor(Math.random() * chordTypes.length)];
      const inversion = inversions[Math.floor(Math.random() * inversions.length)];
      return `${key} ${chordType} (${inversion})`;
    }

    // Initialize chords with random values (only once)
    function initializeChords() {
      if (!isInitialized) {
        currentChordDisplay.textContent = `Play: ${getRandomChord()}`;
        nextChordDisplay.textContent = `Next: ${getRandomChord()}`;
        isInitialized = true; // Mark initialization as complete
      }
    }

    // Function to start the metronome
    function startMetronome() {
      if (interval) clearInterval(interval); // Clear existing interval if any
      const intervalTime = (60 / bpm) * 1000; // Convert BPM to milliseconds
      interval = setInterval(processBeat, intervalTime);
    }

    // Update BPM display and value
    function updateBpm(value) {
      bpm = Math.max(40, Math.min(200, value)); // Clamp BPM between 40 and 200
      bpmSlider.value = bpm;
      bpmValue.textContent = bpm;

      // Restart the metronome with the new BPM if it's already running
      if (interval) {
        startMetronome();
      }
    }

    // BPM control event listeners
    bpmMinus5Button.addEventListener('click', () => updateBpm(bpm - 5));
    bpmMinus1Button.addEventListener('click', () => updateBpm(bpm - 1));
    bpmPlus1Button.addEventListener('click', () => updateBpm(bpm + 1));
    bpmPlus5Button.addEventListener('click', () => updateBpm(bpm + 5));

    // Update BPM slider
    bpmSlider.addEventListener('input', () => updateBpm(parseInt(bpmSlider.value)));

    // Start metronome
    startButton.addEventListener('click', () => {
      initializeChords(); // Initialize chords (only once)
      beat = 0; // Reset beat counter
      firstRound = true; // Reset first round flag
      startMetronome();
    });

    // Stop metronome
    stopButton.addEventListener('click', () => {
      clearInterval(interval);
      interval = null; // Reset interval
      beat = 0; // Reset beat counter
      firstRound = true; // Reset first round flag
      updateBeatMarkers(); // Reset beat markers
    });

    // Update beat markers
    function updateBeatMarkers() {
      beatMarkers.forEach((marker, index) => {
        marker.classList.remove('active');
        if (index === beat) {
          marker.classList.add('active');
        }
      });
    }

    // Update chords
    function updateChords() {
      currentChordDisplay.textContent = `Play: ${nextChordDisplay.textContent.replace('Next: ', '')}`;
      nextChordDisplay.textContent = `Next: ${getRandomChord()}`;
    }

    // Play click sound
    function playClick() {
      // Create oscillator and gain node
      oscillator = audioContext.createOscillator();
      gainNode = audioContext.createGain();

      // Configure oscillator frequency (higher pitch for beat 0)
      const frequency = beat === 0 ? 1200 : 1000; // 1200 Hz for beat 0, 1000 Hz for others
      oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
      oscillator.type = 'square';

      // Configure gain node for a short click sound
      gainNode.gain.setValueAtTime(1, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);

      // Connect nodes
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      // Start and stop oscillator
      oscillator.start();
      oscillator.stop(audioContext.currentTime + 0.05);
    }

    // Process each beat
    function processBeat() {
      // Update chords on beat 0, but skip the first round
      if (beat === 0 && !firstRound) {
        updateChords();
      }

      // Play click sound
      playClick();

      // Update beat display
      updateBeatMarkers();

      // Increment beat counter
      beat = (beat + 1) % 8;

      // End the first round after 8 beats
      if (beat === 0) {
        firstRound = false;
      }
    }

    // Initialize chords when the page loads
    initializeChords();
  </script>
</body>
</html>
